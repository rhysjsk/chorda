<template>
  <div id="keyboard">
    <svg xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="250" width="840" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/">
    <g transform="scale(1.6, 1.6)">
      <g stroke="#202020" stroke-linecap="round" stroke-dasharray="none" stroke-miterlimit="4" stroke-width="1.28102171" transform="translate(0,-932.36218)">
        <path id="k-b5" class="key key-white" d="m418.52,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-f4" class="key key-white" d="m355.83,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-e4" class="key key-white" d="m334.94,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-c4" class="key key-white" d="m293.15,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-b4" class="key key-white" d="m272.26,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-f3" class="key key-white" d="m209.58,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-e3" class="key key-white" d="m188.68,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-c3" class="key key-white" d="m146.9,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-b3" class="key key-white" d="m126,953.01,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-f2" class="key key-white" d="m63.322,953.01,0,3.2162,0,63.237,0,29.057c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.057-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <path id="k-e2" class="key key-white" d="m42.428,953,0,3.2162,0,63.237,0,29.056c0,1.7786,1.4805,3.2052,3.3262,3.2052h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2052v-29.056-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <rect id="k-g3" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="230.47" fill="#9cc8cb"/>
        <rect id="k-a4" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="251.37" fill="#9cc8cb"/>
        <rect id="k-d3" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="167.79" fill="#9cc8cb"/>
        <path id="k-c3-sharp" class="key key-black" d="m162.47,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.9713,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-d3-sharp" class="key key-black" d="m183.31,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.97129,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-f3-sharp" class="key key-black" d="m225,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.97131,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-g3-sharp" class="key key-black" d="m246.26,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.97129,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-a4-sharp" class="key key-black" d="m265.85,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.97129,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <rect id="k-g4" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="376.73" fill="#9cc8cb"/>
        <rect id="k-a5" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="397.62" fill="#9cc8cb"/>
        <rect id="k-d4" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="314.05" fill="#9cc8cb"/>
        <path id="k-c4-sharp" class="key key-black" d="m308.88,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.9713,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-d4-sharp" class="key key-black" d="m329.72,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.97129,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-f4-sharp" class="key key-black" d="m371.41,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.97127,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-g4-sharp" class="key key-black" d="m392.67,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.97127,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-a5-sharp" class="key key-black" d="m412.26,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.97127,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <rect id="k-g2" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="84.216" fill="#9cc8cb"/>
        <rect id="k-a3" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="105.11" fill="#9cc8cb"/>
        <path id="k-c2" class="key key-white" d="m0.64051,953,0,3.2162,0,63.237,0,29.057c0,1.7785,1.4805,3.2051,3.3262,3.2051h14.18c1.8457,0,3.3377-1.4266,3.3377-3.2051v-29.057-63.237-3.2162h-3.3377-14.18-3.3262z" fill="#9cc8cb"/>
        <rect id="k-d2" class="key key-white" ry="3.2103" height="98.718" width="20.844" y="953" x="21.534" fill="#9cc8cb"/>
        <path id="k-c2-sharp" class="key key-black" d="m16.063,953,0,2.1182,0,42.82,0,17.955c0,1.1713,0.9713,2.1182,2.1868,2.1182h6.4568c1.2155,0,2.1983-0.9469,2.1983-2.1182v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-f2-sharp" class="key key-black" d="m78.588,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.9713,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-g2-sharp" class="key key-black" d="m99.851,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.9713,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-a3-sharp" class="key key-black" d="m119.44,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.9713,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
        <path id="k-d2-sharp" class="key key-black" d="m36.901,953,0,2.1182,0,42.82,0,17.955c0,1.1712,0.9713,2.1183,2.1868,2.1183h6.4568c1.2155,0,2.1983-0.9471,2.1983-2.1183v-17.955-42.82-2.1182h-2.1983-6.4568-2.1868z" fill="#1c6c70"/>
      </g>
      <g id="key-0" :transform="translateKey0" font-weight="bold" fill="#000000" :pitch="keys[0].pitch">
          <text class="accidental accented-note" font-family="Didact Gothic" font-size="12px">{{keys[0].note}}</text>
          <text class="accidental natural-note" font-family="Didact Gothic" font-size="14px" x="-4">{{keys[0].note}}</text>
          <text class="accidental flat" font-family="Tahoma" font-size="10px" x="6.5">♭</text>
          <text class="accidental sharp" font-family="Tahoma" font-size="10px" x="6.5">♯</text>
          <text font-family="Didact Gothic" font-size="12px" y="-117" x="-2">{{keys[0].finger}}</text>
      </g>
      <g id="key-1" :transform="translateKey1" font-weight="bold" fill="#000000" :pitch="keys[1].pitch">
          <text class="accidental accented-note" font-family="Didact Gothic" font-size="12px">{{keys[1].note}}</text>
          <text class="accidental natural-note" font-family="Didact Gothic" font-size="14px" x="-4">{{keys[1].note}}</text>
          <text class="accidental flat" font-family="Tahoma" font-size="10px" x="6.5">♭</text>
          <text class="accidental sharp" font-family="Tahoma" font-size="10px" x="6.5">♯</text>
          <text font-family="Didact Gothic" font-size="12px" y="-117" x="-2">{{keys[1].finger}}</text>
      </g>
      <g id="key-2" :transform="translateKey2" font-weight="bold" fill="#000000" :pitch="keys[2].pitch">
          <text class="accidental accented-note" font-family="Didact Gothic" font-size="12px">{{keys[2].note}}</text>
          <text class="accidental natural-note" font-family="Didact Gothic" font-size="14px" x="-4">{{keys[2].note}}</text>
          <text class="accidental flat" font-family="Tahoma" font-size="10px" x="6.5">♭</text>
          <text class="accidental sharp" font-family="Tahoma" font-size="10px" x="6.5">♯</text>
          <text font-family="Didact Gothic" font-size="12px" y="-117">{{keys[2].finger}}</text>
      </g>
      <g id="key-3" :transform="translateKey3" font-weight="bold" fill="#000000" :pitch="keys[3].pitch">
          <text class="accidental accented-note" font-family="Didact Gothic" font-size="12px">{{keys[3].note}}</text>
          <text class="accidental natural-note" font-family="Didact Gothic" font-size="14px" x="-4">{{keys[3].note}}</text>
          <text class="accidental flat" font-family="Tahoma" font-size="10px" x="6.5">♭</text>
          <text class="accidental sharp" font-family="Tahoma" font-size="10px" x="6.5">♯</text>
          <text font-family="Didact Gothic" font-size="12px" y="-117">{{keys[3].finger}}</text>
      </g>
    </g>
    </svg>
  </div>
</template>
<script>

import anime from 'animejs'

const KEY_SEQUENCE = 'abcdefg'
const KEY_WIDTH = 20.9

export default {
  name: 'Keyboard',
  data () {
    return {
      keys: [{pos: 0}, {pos: 0}, {pos: 0}, {pos: 0}]
    }
  },
  props: ['bus'],
  created () {
    this.bus.$on('showChord', (args) => {
      this.showChord(args.chord)
    })
  },
  computed: {
    translateKey0: function () {
      return 'translate(' + this.keys[0].pos + ', 133)'
    },
    translateKey1: function () {
      return 'translate(' + this.keys[1].pos + ', 133)'
    },
    translateKey2: function () {
      return 'translate(' + this.keys[2].pos + ', 133)'
    },
    translateKey3: function () {
      return 'translate(' + this.keys[3].pos + ', 133)'
    }
  },
  mounted () {
    // this.showKeys({c3: 'natural', e3: 'natural', g3: 'sharp'})
  },
  methods: {
    showChord: function (chord) {
      this.keys = [{pos: 0}, {pos: 0}, {pos: 0}, {pos: 0}]
      let keySeq = 0
      let ks = chord.structure

      anime({targets: '.key-white', fill: '#9cc8cb', easing: 'easeInOutCubic', delay: 0, duration: 200})
      anime({targets: '.key-black', fill: '#1c6c70', easing: 'easeInOutCubic', delay: 0, duration: 200})

      for (let k in ks) {
        let key = k.slice(0, 1)
        let octave = k.slice(1, 2)
        let accent = ks[k].pitch

        let accentShift = 0
        switch (accent) {
          case 'sharp':
            if (key === 'e' || key === 'b') accentShift = 1
            else accentShift = 0.5
            break
          case 'flat':
            if (key === 'f' || key === 'c') accentShift = -1
            else accentShift = -0.5
            break
        }
        let keyCount = (octave - 2) * 7 + accentShift + KEY_SEQUENCE.indexOf(key) - 2
        let position = (keyCount + 0.5) * KEY_WIDTH
        this.keys[keySeq] = {note: key.toUpperCase(), pos: position, pitch: accent, keyCount: keyCount, finger: ks[k].finger}
        keySeq++
        let animK = k
        if (accent === 'flat') {
          let animNote = KEY_SEQUENCE.indexOf(key)
          animNote = animNote - 1
          if (animNote < 0) {
            animNote = animNote + KEY_SEQUENCE.length
            octave -= 1
          }
          animK = KEY_SEQUENCE[animNote] + octave
          accent = 'sharp'
        }
        let animateTarget = animK + ((accent !== 'natural') ? '-' + accent : '')
        let fill = (keyCount === Math.round(keyCount)) ? '#ffffff' : '#000000'
        anime.remove('#k-' + animateTarget)
        anime({ targets: '#k-' + animateTarget, fill: fill, easing: 'easeInOutCubic', delay: 20, duration: 300 })
      }
    }
  }
}
</script>
<style>
.accidental {
  opacity:0;
}
[pitch="sharp"] .sharp, [pitch="sharp"] .accented-note {
  opacity: 1;
}
[pitch="flat"] .flat, [pitch="flat"] .accented-note {
  opacity: 1;
}
[pitch="natural"] .natural-note {
  opacity: 1;
}

</style>
